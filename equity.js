import*as e from"https://cdn.jsdelivr.net/npm/csv@6.3.9/+esm";import t from"https://cdn.jsdelivr.net/npm/dayjs@1.11.11/+esm";import o from"https://cdn.jsdelivr.net/npm/dayjs@1.11.11/plugin/customParseFormat/+esm";import n from"https://cdn.jsdelivr.net/npm/xml-js@1.6.11/+esm";import{TabulatorFull as r}from"https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.1/+esm";import a from"https://cdn.jsdelivr.net/npm/highcharts@11.4.6/+esm";t.extend(o);let i=[],l=[],s=[];const m=[],c=[],d=[];let u=0,p=0,f=0,y=0,g=0,Y=new Map;const T=()=>{const e=document.getElementById("draw");e.disabled=!1,e.style.backgroundColor="#04AA6D",e.style.color="#FFFFFF",e.style.cursor="pointer"};document.getElementById("buttonImportTradersdiaries").addEventListener("click",(()=>{document.getElementById("inputFileTradersdiaries").click()})),document.getElementById("buttonImportKas").addEventListener("click",(()=>{document.getElementById("inputFileKas").click()})),document.getElementById("inputFileKas").addEventListener("change",(e=>{const o=e.target.files[0];document.getElementById("kasFileName").innerText=o.name;const n=new FileReader;n.onload=e=>{const o=e.target.result;if(!o)return void alert("Пустой HTML файл!");const n=(new DOMParser).parseFromString(o,"text/html"),r=n.querySelectorAll("table tr");u=0,p=0;for(const e of r){const o=e.children[2].innerText;if(m.push(o),o.includes("PayOut")){const o=e.children[0].innerText,n=e.children[1].innerText,r=parseInt(n.split(/[\s\u00A0]/).join(""));c.push({platform:"MOEX",closeTime:t(o,"YYYY-MM-DD").toDate(),symbol:"PayOut",profit:r}),p+=r}else if(o.includes("фандинга")){const n=o.match(/(?<=по ).+$/)?.[0],r=e.children[0].innerText,a=e.children[1].innerText,i=parseInt(a.split(/[\s\u00A0]/).join(""));d.push({platform:"MOEX",closeTime:t(r,"YYYY-MM-DD"),symbol:n,profit:i}),u+=i}}const a=n.querySelector(".accountInfo .balance").innerHTML;f=parseInt(a.split(/&nbsp;/).join("")),T()},n.readAsText(o)})),document.getElementById("inputFileTradersdiaries").addEventListener("change",(o=>{const n=o.target.files[0];document.getElementById("tradersdiariesFileName").innerText=n.name;const r=new FileReader;r.onload=o=>{const n=o.target.result;n?e.parse(n,{delimiter:";",columns:!0,trim:!0},((e,o)=>{if(e)return void console.error(e);o.some((e=>!!e.Symbol||!!e.Profit||!!e.Date))?(i=o.map((e=>({platform:"MOEX",profit:parseFloat(e.Profit),symbol:e.Symbol,closeTime:t(`${e.Date} ${e.Time}`,"YYYY-MM-DD HH:mm:ss").toDate()}))),T()):alert("Кажется, это не таблца трейдов Tradersdiaries")})):alert("Пустой файл!")},r.readAsText(n)}));const h=e=>{const o=t(e);let n=Y.get(o.format("DD.MM.YYYY"));return n||(n=Y.get(o.subtract(1,"day").format("DD.MM.YYYY")),n||(n=Y.get(o.subtract(2,"day").format("DD.MM.YYYY")),n||(n=Y.get(o.add(1,"day").format("DD.MM.YYYY")),n||(n=Y.get(o.add(2,"day").format("DD.MM.YYYY")),n||NaN))))};document.getElementById("inputFileXpbee").addEventListener("change",(o=>{const r=o.target.files[0];document.getElementById("xpbeeFileName").innerText=r.name;const a=new FileReader;a.onload=o=>{if(!o.target.result)return void alert("Пустой файл!");const r=o.target.result.split("\n").map((e=>e.trim())),a=parseFloat(r[r.length-2].split(/[\s\u00A0]/).join("")),i=r.findIndex((e=>e.startsWith(","))),s=r.slice(0,i).join("\n");e.parse(s,{delimiter:",",from_line:2,columns:!0},(async(e,o)=>{if(e)return void console.error(e);if(!o.some((e=>!!e["Net USDT"]||!!e["Closing Time (UTC+3)"])))return void alert("Кажется, это не выписка XP BEE");const r=o.map((e=>({platform:"XP BEE",profit:parseFloat(e["Net USDT"]),symbol:e.Symbol,closeTime:t(e["Closing Time (UTC+3)"],"DD MMM YYYY HH:mm:ss.SSS").toDate()}))).sort(((e,t)=>e.closeTime<t.closeTime?-1:e.closeTime>t.closeTime?1:0)),i=r[0];await(async(e,o)=>{try{const r=t(e).subtract(2,"day").format("DD/MM/YYYY"),a=t(o).format("DD/MM/YYYY"),i=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.cbr.ru/scripts/XML_dynamic.asp?date_req1=${r}&date_req2=${a}&VAL_NM_RQ=R01235`)}`),l=await i.json();if(l?.contents){const e=JSON.parse(n.xml2json(l.contents,{compact:!0}));Y.clear(),e.ValCurs.Record.forEach((e=>{Y.set(e._attributes.Date,parseFloat(e.Value._text.replace(",",".")))}))}}catch(e){console.error(e)}})(i.closeTime,new Date),r.forEach((e=>{e.usdRate=h(e.closeTime),e.profit=e.profit*e.usdRate})),g=h(new Date),y=a*g,l=r,T()}))},a.readAsText(r)})),document.getElementById("buttonImportXpbee").addEventListener("click",(()=>{document.getElementById("inputFileXpbee").click()})),document.getElementById("draw").addEventListener("click",(()=>{s=i.concat(...l).concat(...d).concat(...c).sort(((e,t)=>e.closeTime<t.closeTime?-1:e.closeTime>t.closeTime?1:0)).map(((e,t)=>({...e,id:t,closeTime:e.closeTime})));if(!s.length)return;const e=Object.groupBy(s,(({closeTime:e})=>t(e).format("YYYY-MM-DD"))),o=Object.entries(e).map((([e,o])=>({profit:o.reduce(((e,t)=>e+t.profit),0),closeTime:t(e,"YYYY-MM-DD").toDate()}))),n=Object.groupBy(s,(({closeTime:e})=>t(e).format("YYYY-MM"))),m=Object.entries(n).map((([e,o])=>({profit:o.reduce(((e,t)=>e+t.profit),0),closeTime:t(e,"YYYY-MM").toDate()}))),Y=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB"});document.getElementById("statsText").style.display="flex",document.getElementById("totalFunding").innerText=Y.format(u),document.getElementById("totalPayout").innerText=Y.format(p),document.getElementById("totalDeposit").innerText=Y.format(y+f),document.getElementById("currentRate").innerText=Y.format(g),document.querySelectorAll(".tableHeader").forEach((e=>{e.style.display="block"}));new r("#equityTableContainer",{height:500,width:300,data:s,layout:"fitData",columns:[{title:"ID",field:"id"},{title:"Платформа",field:"platform"},{title:"Инструмент",field:"symbol"},{title:"Время закрытия",field:"closeTime",formatter:e=>e.getValue().toLocaleString("ru-RU")},{title:"Курс $ (XB BEE)",field:"usdRate",formatter:"money",formatterParams:{decimal:",",thousand:" ",symbol:" ₽",symbolAfter:!0}},{title:"PnL",field:"profit",formatter:"money",formatterParams:{decimal:",",thousand:" ",symbol:" ₽",symbolAfter:!0}}]}).on("renderComplete",(()=>{let e=0;a.chart("equityChartContainer",{title:{text:"PnL по сделкам",align:"left"},yAxis:{title:{text:"Общий PnL"}},xAxis:{},legend:{layout:"vertical",align:"right",verticalAlign:"middle"},tooltip:{valueSuffix:" ₽",valueDecimals:2},plotOptions:{series:{label:{connectorAllowed:!1},animation:!1}},chart:{zooming:{type:"xy"}},navigation:{buttonOptions:{enabled:!0}},series:[{name:"PnL",data:s.map((t=>(e+=t.profit,e)))}]})}));new r("#dailyTableContainer",{height:500,width:300,data:o,index:"closeTime",layout:"fitData",columns:[{title:"Дата закрытия",formatter:e=>e.getValue().toLocaleDateString("ru-RU"),field:"closeTime"},{title:"PnL",field:"profit",formatter:"money",formatterParams:{decimal:",",thousand:" ",symbol:" ₽",symbolAfter:!0}}]}).on("renderComplete",(()=>{let e=0;a.chart("dailyChartContainer",{title:{text:"PnL по датам",align:"left"},yAxis:{title:{text:"Общий PnL"}},xAxis:{title:{text:"Дата"},type:"category"},legend:{layout:"vertical",align:"right",verticalAlign:"middle"},tooltip:{valueSuffix:" ₽",valueDecimals:2},plotOptions:{series:{label:{connectorAllowed:!1},animation:!1}},chart:{zooming:{type:"xy"}},navigation:{buttonOptions:{enabled:!0}},series:[{name:"PnL",data:o.map((o=>[t(o.closeTime).format("DD.MM.YYYY"),e+=o.profit]))}]})})),new r("#monthlyTableContainer",{height:500,width:300,data:m,index:"closeTime",layout:"fitData",columns:[{title:"Время закрытия",field:"closeTime",formatter:e=>e.getValue().toLocaleDateString("ru-RU",{year:"numeric",month:"long"})},{title:"PnL",field:"profit",formatter:"money",formatterParams:{decimal:",",thousand:" ",symbol:" ₽",symbolAfter:!0}}]})}));
